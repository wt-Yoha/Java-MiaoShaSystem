<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="assets/images/favicon.png"/>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="assets/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="assets/css/animate.css"/>
    <link rel="stylesheet" type="text/css" href="assets/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="assets/css/chosen.min.css"/>
    <link rel="stylesheet" type="text/css" href="assets/css/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="assets/css/jquery.scrollbar.css"/>
    <link rel="stylesheet" type="text/css" href="assets/css/lightbox.min.css"/>
    <link rel="stylesheet" type="text/css" href="assets/css/magnific-popup.css"/>
    <link rel="stylesheet" type="text/css" href="assets/css/slick.min.css"/>
    <link rel="stylesheet" type="text/css" href="assets/fonts/flaticon.css"/>
    <link rel="stylesheet" type="text/css" href="assets/css/megamenu.css"/>
    <link rel="stylesheet" type="text/css" href="assets/css/dreaming-attribute.css"/>
    <link rel="stylesheet" type="text/css" href="assets/css/style.css"/>
    <title>Kobolg - HTML Template </title>
</head>
<body class="single single-product">
<div id="myHeader"></div>
<div id="myContainer">
    <div class="banner-wrapper no_background">
        <div class="banner-wrapper-inner">
            <nav class="kobolg-breadcrumb container"><a href="index.html">Home</a><i class="fa fa-angle-right"></i><a
                    href="#">Shop</a>
                <i class="fa fa-angle-right"></i>Single Product
            </nav>
        </div>
    </div>
    <div class="single-thumb-vertical main-container shop-page no-sidebar">
        <div class="container">
            <div class="row">
                <div class="main-content col-md-12">
                    <div class="kobolg-notices-wrapper"></div>
                    <div id="product-27"
                         class="post-27 product type-product status-publish has-post-thumbnail product_cat-table product_cat-new-arrivals product_cat-lamp product_tag-table product_tag-sock first instock shipping-taxable purchasable product-type-variable has-default-attributes">
                        <div class="main-contain-summary">
                            <div class="contain-left has-gallery">
                                <div class="single-left">
                                    <div class="kobolg-product-gallery kobolg-product-gallery--with-images kobolg-product-gallery--columns-4 images">
                                        <a href="#" class="kobolg-product-gallery__trigger">
                                            <img draggable="false" class="emoji" alt="🔍"
                                                 src="https://s.w.org/images/core/emoji/11/svg/1f50d.svg"></a>
                                        <div class="flex-viewport">
                                            <figure class="kobolg-product-gallery__wrapper">
                                                <div class="kobolg-product-gallery__image">
                                                    <img alt="img"
                                                         src="assets/images/apro131-2.jpg">
                                                </div>
                                            </figure>
                                        </div>

                                    </div>
                                </div>
                                <div class="summary entry-summary">
                                    <div class="flash">
                                        <span class="onnew"><span class="text">New</span></span></div>
                                    <h1 class="product_title entry-title">T-shirt with skirt</h1>
                                    <p class="price">
                                    <span class="kobolg-Price-amount amount">
                                        <span class="kobolg-Price-currencySymbol">$</span>185.00
                                    </span>
                                    </p>
                                    <p class="stock in-stock">
                                        <!--                                        普通商品 -->
                                        <!--                                        <span>库存: </span>-->
                                        <!--                                        <span>已售罄</span>-->

                                        <!--                                        秒杀商品-->
                                        <!--                                        <span>活动开始还有：</span>-->
                                        <!--                                        <span>活动结束还有: </span>-->
                                        <!--                                        <span>活动已结束</span>-->
                                        <span id="goodsStatus"></span>
                                        <span id="remainTime"></span>
                                    </p>
                                    <div class="kobolg-product-details__short-description">
                                        <p>Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac
                                            turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget,
                                            tempor
                                            sit amet, ante.</p>
                                    </div>
                                    <form class="variations_form cart">
                                        <div class="single_variation_wrap">
                                            <div class="kobolg-variation single_variation"></div>
                                            <div class="kobolg-variation-add-to-cart variations_button">
                                                <div class="quantity">
                                                    <span class="qty-label">Quantiy:</span>
                                                    <div class="control">
                                                        <a class="btn-number qtyminus quantity-minus" href="#">-</a>
                                                        <input type="text" data-step="1" min="0" max=""
                                                               name="quantity[25]" value="1" title="Qty"
                                                               class="input-qty input-text qty text" size="4"
                                                               pattern="[0-9]*" inputmode="numeric">
                                                        <a class="btn-number qtyplus quantity-plus" href="#">+</a>
                                                    </div>
                                                </div>
                                                <button id="getOrderBtn" type="button"
                                                        class="single_add_to_cart_button button alt kobolg-variation-selection-needed">
                                                    下单
                                                </button>
                                                <input name="add-to-cart" value="27" type="hidden">
                                                <input name="product_id" value="27" type="hidden">
                                                <input name="variation_id" class="variation_id" value="0" type="hidden">
                                            </div>
                                        </div>
                                    </form>
                                    <div class="yith-wcwl-add-to-wishlist">
                                        <div class="yith-wcwl-add-button show">
                                            <a href="#" rel="nofollow"
                                               data-product-id="27" data-product-type="variable"
                                               class="add_to_wishlist">
                                                Add to Wishlist</a>
                                        </div>
                                    </div>
                                    <div class="clear"></div>
                                    <a href="#"
                                       class="compare button" data-product_id="27" rel="nofollow">Compare</a>
                                    <div class="product_meta">
                                        <div class="wcml-dropdown product wcml_currency_switcher">
                                            <ul>
                                                <li class="wcml-cs-active-currency">
                                                    <a class="wcml-cs-item-toggle">USD</a>
                                                    <ul class="wcml-cs-submenu">
                                                        <li>
                                                            <a>EUR</a>
                                                        </li>
                                                    </ul>
                                                </li>
                                            </ul>
                                        </div>
                                        <span class="sku_wrapper">SKU: <span class="sku">885B712</span></span>
                                        <span class="posted_in">Categories: <a
                                                href="#"
                                                rel="tag">Game & Consoles</a>, <a
                                                href="#" rel="tag">New arrivals</a>, <a
                                                href="#" rel="tag">Summer Sale</a></span>
                                        <span class="tagged_as">Tags: <a href="#"
                                                                         rel="tag">Game & Consoles</a>, <a
                                                href="#" rel="tag">Sock</a></span>
                                    </div>
                                    <div class="kobolg-share-socials">
                                        <h5 class="social-heading">Share: </h5>
                                        <a target="_blank" class="facebook" href="#">
                                            <i class="fa fa-facebook-f"></i>
                                        </a>
                                        <a target="_blank" class="twitter"
                                           href="#"><i class="fa fa-twitter"></i>
                                        </a>
                                        <a target="_blank" class="pinterest"
                                           href="#"> <i class="fa fa-pinterest"></i>
                                        </a>
                                        <a target="_blank" class="googleplus"
                                           href="#"><i class="fa fa-google-plus"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="myFooter"></div>
<div class="footer-device-mobile">
    <div class="wapper">
        <div class="footer-device-mobile-item device-home">
            <a href="index.html">
					<span class="icon">
						<i class="fa fa-home" aria-hidden="true"></i>
					</span>
                Home
            </a>
        </div>
        <div class="footer-device-mobile-item device-home device-wishlist">
            <a href="wishlist.html">
					<span class="icon">
						<i class="fa fa-heart" aria-hidden="true"></i>
					</span>
                Wishlist
            </a>
        </div>
        <div class="footer-device-mobile-item device-home device-cart">
            <a href="cart.html">
					<span class="icon">
						<i class="fa fa-shopping-basket" aria-hidden="true"></i>
						<span class="count-icon">
							0
						</span>
					</span>
                <span class="text">Cart</span>
            </a>
        </div>
        <div class="footer-device-mobile-item device-home device-user">
            <a href="my-account.html">
					<span class="icon">
						<i class="fa fa-user" aria-hidden="true"></i>
					</span>
                Account
            </a>
        </div>
    </div>
</div>
<a href="#" class="backtotop active">
    <i class="fa fa-angle-up"></i>
</a>
<script src="assets/js/jquery-1.12.4.min.js"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/js/chosen.min.js"></script>
<script src="assets/js/countdown.min.js"></script>
<script src="assets/js/jquery.scrollbar.min.js"></script>
<script src="assets/js/lightbox.min.js"></script>
<script src="assets/js/magnific-popup.min.js"></script>
<script src="assets/js/slick.js"></script>
<script src="assets/js/jquery.zoom.min.js"></script>
<script src="assets/js/threesixty.min.js"></script>
<script src="assets/js/jquery-ui.min.js"></script>
<script src="assets/js/mobilemenu.js"></script>
<script src='http://www.google.cn/maps/api/js?key=AIzaSyC3nDHy1dARR-Pa_2jjPCjvsOR4bcILYsM'></script>
<script src="assets/js/functions.js"></script>
<script src="assets/js/PageUtils.js"></script>
<script>
    $(function () {
        loadHeaderAndFooter();
        renderPage();
    });

    function renderPage() {
        var goodsId = getUrlParam("goodsId");
        $.ajax({
            url: contentUrl("/goods/detail/" + goodsId),
            type: "GET",
            success: (result) => {
                resultProcessing(
                    result,
                    (result) => {
                        var continueTime = result.data.continueTime;
                        var remainTime = [result.data.remainTime];
                        var status = [result.data.status];
                        var goods = result.data.goods;
                        // 填充标题
                        $(".product_title.entry-title").text(goods.name);
                        // 填充price
                        var price = $(".price");
                        price.empty();
                        if (goods.miaoShaGoods === null) {
                            price.html("<ins><span class=\"kobolg-Price-amount amount\"><span class=\"kobolg-Price-currencySymbol\">$</span>" + goods.price + "</span></ins>");
                        } else {
                            price.html("<del><span class=\"kobolg-Price-amount amount\"><span class=\"kobolg-Price-currencySymbol\">$</span>" + goods.price + "</span></del>");
                            price.html(price.html() + "&nbsp&nbsp<ins><span class=\"kobolg-Price-amount amount\"><span class=\"kobolg-Price-currencySymbol\">$</span>" + goods.miaoShaGoods.miaoshaPrice + "</span></ins>");
                        }
                        // 填充detail
                        $(".kobolg-product-details__short-description p").text(goods.detail);
                        // 商品图片
                        $("figure div img").attr("src", contentUrl("/assets/images/" + goods.largeImg));
                        // 购买数量选择
                        var quantity = $(".control input");
                        quantity.attr("min", 1);
                        if (goods.miaoShaGoods === null) {
                            // 普通商品
                            quantity.attr("max", goods.stock);
                        } else {
                            // 秒杀商品限拍一件
                            quantity.attr("max", 1);
                        }
                        // 下单动作
                        $("#getOrderBtn").attr("onclick", "submitOrder()");

                        // 倒计时
                        countDown(remainTime, status, goods);
                    }
                );
            }

        })
    }

    // 下单动作
    function submitOrder() {
        const goodsId = getUrlParam("goodsId");
        const quantity = $(".control input").val();
        $.ajax({
            url: contentUrl("/order/take"),
            data: {id: goodsId, quantity: quantity},
            type: "POST",
            success:
                (result) => {
                    $("#myContainer").load("takeOrderSegment.html", function () {
                        resultProcessing(
                            result,
                            queryTakerOrder,
                            alertErrorMsg
                        )
                    });
                }
        });
    }

    // 查询当前下单流程的状态
    function queryTakerOrder(result){
        let takeOrderStatus = result.data.status;
        let takeOrderId = result.data.id;
        $.ajax({
            url: contentUrl("/order/queryTakeOrderStatus"),
            data: {id: takeOrderId},
            method: "POST",
            success: function (res) {
                takeOrderStatus = res.data.status;
                takeOrderId = res.data.id;
                if (takeOrderStatus === 0) {
                    // 订单排队中
                    let t = $("#time");
                    t.text(parseInt(t.text()) - 1);
                    setTimeout(function () {
                        queryTakerOrder(res);
                    }, 1000);
                } else if (takeOrderStatus === 1) {
                    location.href = contentUrl("/order.html?orderId=" + res.data.orderInfo.id);
                } else {
                    alertErrorMsg("错误的订单状态");
                }
            }
        })
    }

    // 使用单元素数组是为了可以在函数中修改参数的值
    function countDown(remainTime, status, goods) {
        var timeout;
        var goodsStauts = $("#goodsStatus");
        var timeNode = $("#remainTime");
        // status 0 秒杀未开始 1 秒杀开始 -1 秒杀已结束
        if (remainTime[0] > 0) {
            // 计时器需要启动 可能是秒杀未开始-->开始倒计时，可能是秒杀已开始-->结束倒计时
            if (status[0] === 0) {
                // 此时秒杀未开始
                $("#getOrderBtn").attr("disabled", true);
                goodsStauts.text("活动开始还有：");
            } else if (status[0] === 1) {
                // 秒杀已开始
                $("#getOrderBtn").attr("disabled", false);
                goodsStauts.text("活动结束还有：");
            }
            timeout = setTimeout(function () {
                remainTime[0] -= 1000;
                timeNode.text(convertTime(remainTime[0]));
                countDown(remainTime, status, goods);
            }, 1000);
        } else {
            // remainTime小于等于0 可能是秒杀开始倒计时结束 status = 0、秒杀中倒计时结束 status = 1，普通商品 status = -1
            if (status[0] === 0) {
                // 秒杀开始
                location.reload();
            } else if (status[0] === 1) {
                // 秒杀结束
                clearTimeout(timeout);
                $("#getOrderBtn").attr("disabled", "true");
                goodsStauts.text("活动已结束");
            } else {
                if (goods.miaoShaGoods === null) {
                    // 普通商品
                    if (goods.stock > 0) {
                        goodsStauts.text("库存：" + goods.stock);
                    } else {
                        goodsStauts.text("已售罄");
                    }
                } else {
                    // 秒杀商品
                    $("#getOrderBtn").attr("disabled", "true");
                    goodsStauts.text("活动已结束");
                }
            }
        }
    }

    function convertTime(time) {
        var seconds = time / 1000;
        var minute = seconds / 60;
        seconds = seconds % 60;
        var hour = minute / 60;
        minute = minute % 60;
        var day = hour / 24;
        hour = hour % 24;
        var res = "";
        day = parseInt(day);
        hour = parseInt(hour);
        minute = parseInt(minute);
        seconds = parseInt(seconds);
        if (day !== 0) {
            res = res + day + " 天 ";
        }
        if (hour !== 0) {
            res = res + hour + " 时 ";
        }
        if (minute !== 0) {
            res = res + minute + " 分 ";
        }
        if (seconds !== 0) {
            res = res + seconds + " 秒";
        }
        return res;
    }
</script>
</body>
</html>